{% extends "base.html" %}
{% load l10n_tags %}
{% load i18n %}
{% load learn_tags %}

{% block title %}[{{course.short_title}}] {{course.title}}{% endblock %}
{% block bodyclasses %}course-landing{% endblock%}

{% block css %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/course.css">
<link rel="stylesheet" href="{{ STATIC_URL }}pagedown/pagedown.css">
{% endblock %}

{% block links %}
{% if project %}
  <meta name="thumbnail" property="og:image" content="{{ project.get_image_url }}" />
{% endif %}
{% endblock %}

{% block breadcrumbs_title %}
  <h1 id="project-name">
    [{{course.short_title}}{% if organizer %}
      <a data-toggle="collapse" data-target="#short-title-edit" href="#"><i class="icon-edit"></i></a>
    {% endif %}] 
    {{course.title}}
    {% if organizer %}
      <a data-toggle="collapse" data-target="#title-edit" href="#"><i class="icon-edit"></i></a>
    {% endif %}
  </h1>
  <div id="short-title-edit" class="collapse">
    <form class="form-inline" action="{% locale_url courses_update_attribute course_id=course.id attribute='short_title' %}" method="POST">
      {% csrf_token %}
      <p>{{ update_form.short_title }}</p>
      <button type="submit">{% trans "Update short title" %}</button>
    </form>
  </div>
  <div id="title-edit" class="collapse">
    <form class="form-inline" action="{% locale_url courses_update_attribute course_id=course.id attribute='title' %}" method="POST">
      {% csrf_token %}
      <p>{{ update_form.title }}</p>
      <button type="submit">{% trans "Update title" %}</button>
    </form>
  </div>
{% endblock %}

{% block breadcrumbs %}
{% endblock %}

{% block body %}

<div class="row">
<div id="sidebar-wrapper" class="span3">
<div id="sidebar">
  <section id="project" class="panel">
    <figure class="project_img">
      <a id="id-course-image-link" href="{{ course.get_absolute_url }}">
        {% if course.image %}
  	         <img id="id-course-image" src="{{ course.image.url }}" alt="course image"/>
        {% else %}
             <img id="id-course-image" src="{{ STATIC_URL}}images/project-missing.png" alt="course image"/>
        {% endif %}
        {% if course.draft %}
          <img id="id-course-image-overlay" src="{{ STATIC_URL }}images/course-draft.png" alt="draft course"/>
        {% endif %}
      </a>
    </figure>
    {% if organizer %}
      <p>
        <a data-toggle="collapse" data-target="#image-edit">
          {% trans 'Change image' %}
        </a>
      </p>
      <div id="image-edit" class="collapse">
        <form action="{% locale_url courses_image course_id=course.id %}" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <p>{{image_form.image}}</p>
          <p><button type="submit" >{% trans 'Upload new image' %}</button></p>
        </form>
      </div>
    {% endif %}
    <hr/>
    <div id="course-description">
      <p>{{ course.plug }}</p>
      {% if organizer %}
      <a data-toggle="collapse" data-target="#plug-edit">{% trans "edit" %}</a>
      <div id="plug-edit" class="collapse">
        <form action="{% locale_url courses_update_attribute course_id=course.id attribute='plug' %}" method="POST">
          {% csrf_token %}
          {{ update_form.plug }}
          <p><button type="submit">{% trans "Update plug" %}</button></p>
        </form>
      </div>
      {% endif %}
    </div>
  {% if organizer and course.draft %}
    <hr/>
    <div>
     <p>{% trans "This course is still a draft" %}</p>
      <form action="{% locale_url courses_change_status course_id=course.id status='publish' %}" method="POST">
        {% csrf_token %}
        <p><button type="submit">{% trans "Publish" %}</button></p>
      </form>
      {% if not course.draft and not course.archived %}
        <p>{% trans "Published" %}</p>
          <form action="{% locale_url courses_change_status course_id=course.id status='archive' %}" method="POST">
            {% csrf_token %}
            <p><button type="submit">{% trans "Archive" %}</button></p>
        </form>
      {% endif %}
      {% if course.archived %}
        <p>{% trans "Archived" %}</p>
        <form action="{% locale_url courses_change_status course_id=course.id status='publish' %}" method="POST">
            {% csrf_token %}
            <p><button type="submit">{% trans "Resurrect" %}</button></p>
        </form>
      {% endif %}
    </div>
  {% endif %}
    <hr/>
    <div id="course-term">
      {% if cohort.term == 'ROLLING' %}
        <p>{%trans "This course doesn't have start and end dates"%}</p>
      {% else %}
        {% blocktrans with start_date=cohort.start_date end_date=cohort.end_date %}
          <p>This course runs from {{ start_date }} to {{end_date}}</p>
        {% endblocktrans %}
      {% endif %}

      {% if organizer %}
        <p><a data-toggle="collapse" data-target="#term-edit">{% trans 'edit' %}</a></p>
        <div id="term-edit" class="collapse">
          {%trans "Switch to fixed term and set dates"%}
          <form action="{% locale_url courses_change_term course_id=course.id term='fixed' %}" method="POST">
            {% csrf_token %}
            <p><label for="id_start_date">{% trans 'Start:' %}</label>{{term_form.start_date}}</p>
            <p><label for="id_end_date">{% trans 'End:' %}</label>{{term_form.end_date}}</p>
            <p><input type="submit" value="{% trans "Update fixed term" %}"/></p>
          </form>
          {% if cohort.term == 'FIXED' %}
            <form action="{% locale_url courses_change_term course_id=course.id term='rolling' %}">
              <p><input type="submit" value="{% trans "Switch to rolling term" %}"/></p>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <hr/>
    <div>
      {% if cohort.signup == 'OPEN' %}
        <p>{% trans 'Singup is open. Anyone can sign up once the course is published!' %}</p>
      {% endif %}
      {% if cohort.signup == 'MODERATED' %}
        <p>{% trans 'Singup is moderated. To sign up for this course you should contact one of the course organizer.' %}</p>
      {% endif %}
      {% if cohort.signup == 'CLOSED' %}
        <p>{% trans 'Singup is closed. Only organizer can add more people.' %}</p>
      {% endif %}
      {% if organizer %}
        <p><a data-toggle="collapse" data-target="#signup-edit">{% trans "change" %}</a></p>
        <div id="signup-edit" class="collapse">
          {% if cohort.signup != 'OPEN' %}
            <form action="{% locale_url courses_change_signup course_id=course.id signup='open'%}" method="POST">
              {% csrf_token %}
              <p><button type="submit">{% trans 'Change to Open' %}</button></p>
            </form>
          {% endif %}
          {% if cohort.signup != 'MODERATED' %}
            <form action="{% locale_url courses_change_signup course_id=course.id signup='moderated'%}" method="POST">
              {% csrf_token %}
              <p><button type="submit">{% trans 'Change to Moderated' %}</button></p>
            </form>
          {% endif %}
          {% if cohort.signup != 'CLOSED' %}
            <form action="{% locale_url courses_change_signup course_id=course.id signup='closed'%}" method="POST">
              {% csrf_token %}
              <p><button type="submit">{% trans 'Change to Closed' %}</button></p>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div id="course-singup">
      {% if show_signup %}
        <form method="post" action="{% locale_url courses_signup course_id=course.id %}">
          {% csrf_token %}
          <p><button id="signup_button">{{ _('Start Course') }}</button></p>
        </form>
      {% endif %}
      {% if show_leave_course %}
        <form method="post" action="{% locale_url courses_leave course_id=course.id username=user.username %}">
          {% csrf_token %}
          <p><button id="leave_direct_signup_button">{{ _('Leave Course') }}</button></p>
        </form>
      {% endif %}
    </div>
    {% if tags %}
      <h3><b>{{ _('Tags') }}</b></h3>
      <ul class="tags">
        {% for tag in tags %}
          <li>
            <a href="{% learn_default tag %}" title="{{ _('View more tagged with ') }}{{ tag.name }}">
              {{ tag.name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    {% if organizer %}
      <hr/>
      <div id="course-language">
        <a data-toggle="collapse" data-target="#language-edit">Change language of course</a>
        <div id="language-edit" class="collapse">
          <form action="{% locale_url courses_change_language course_id=course.id %}" method="POST">
            {% csrf_token %}
            {{ language_form }}
            <button type="submit">{% trans "update language" %}</button>
          </form>
        </div>
      </div>
    {% endif %}
  </section>

</div> <!-- /#sidebar -->
</div>


<div id="main" class="span9">

  <div class="tabbable">
    <ul class="nav nav-tabs">
      <li class="active"><a href="#about-tab" data-toggle="tab">{% trans 'About' %}</a></li>
      <li><a href="#content-tab" data-toggle="tab">{% trans 'Content' %}</a></li>
      <li><a href="#discussion-tab" data-toggle="tab">{% trans 'Discussion' %}</a></li>
      <li><a href="#badges-tab" data-toggle="tab">{% trans 'Badges' %}</a></li>
      <li><a href="#people-tab" data-toggle="tab">{% trans 'People' %}</a></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane active" id="about-tab">
        {% if about.content|length == 0 %}
          <p>{% blocktrans %}There is no description what this course is about. You can add a description by editing this page.</a>{% endblocktrans %}
          </p>
        {% endif %}
        <div id="id_content-wmd-preview"></div>
        <p>
        {% if organizer %}
          <a data-toggle="collapse" data-target="#about-editor">
            <i class="icon-edit"></i>
          </a>
        {% endif %}
        </p>
        <div id="about-editor" class="collapse">
          <form action="{% locale_url courses_edit_content course_id=course.id content_id=about.id %}" method="POST">
            {% csrf_token %}
            <input type="hidden" value="{{course_url}}" name="next_url"/>
            <input type="hidden" value="About" name="title"/>
            <div id="id_content-wmd-button-bar"></div>
            <p>
              <textarea id="id_content" name="content" class="span9" rows="{{about.rows}}">{{about.content}}</textarea>
            </p>
            <input type="submit" value="{% trans 'Update about page!' %}"/>
          </form>
        </div>
      </div>
  
      <div class="tab-pane" id="content-tab">
        {% if course.content|length %}
          <ul>
            {% for task in course.content %}
              <li class="{% cycle 'odd' 'even' %}">
                <a class="taskLink" href="{% locale_url courses_content_show course_id=course.id, content_id=task.id %}">{{ task.title }}</a>
                {% if organizer %}
                    {% if not forloop.first %}<a class="robttn up" href="{% locale_url courses_content_up course_id=course.id content_id=task.id %}"><i class="icon-arrow-up"></i></a>{% endif %}
                    {% if not forloop.last %}<a class="robttn dwn" href="{% locale_url courses_content_down course_id=course.id content_id=task.id%}"><i class="icon-arrow-down"></i></a>{% endif %}
                {% endif %}
                <!--a class="taskView" href="#">{{ _('View and Discuss') }}</a-->

                {% if organizer %}
                <!--a href="{% locale_url courses_edit_content course_id=course.id content_id=task.id %}?next_url={{ course_url }}">
                    <i class="icon-edit"></i>
                </a-->
                {% endif %}
              </li>
            {% endfor %}
            {% if organizer %}
              <a href="{% locale_url courses_create_content course_id=course.id %}?next_url={{ course_url }}">
                <i class="icon-plus"></i>
              </a>
            {% endif %}
          </ul>
        {% else %}
          {% if organizer %}
            <p>{% blocktrans %}No content have been added. {% endblocktrans %}<a href="{% locale_url courses_create_content course_id=course.id%}">Click here</a> to add some content</p>
          {% endif %}
        {% endif %}
      </div>
  
      <div class="tab-pane" id="discussion-tab">
        <div id="disqus_thread"></div>
          <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'p2pu'; // required: replace example with your forum shortname
            var disqus_developer = 1;
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        <!--
        {% for comment in comments %}
          <div class="comment">
            <a name="comment-{{comment.id}}"></a>
            <p>{{comment.content}}</p>
            {% if comment.replies|length > 0 %}
              <a data-toggle="collapse" data-target="#comment-{{comment.id}}-replies">
                {% blocktrans with reply_count=comment.replies|length %}{{reply_count}} replies{% endblocktrans %}
              </a>
              <div id="comment-{{comment.id}}-replies" class="collapse">
                {% for reply in comment.replies %}
                  <div class="reply">
                    <a name="comment-{{reply.id}}"></a>
                    <p>{{reply.content}}</p>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            <a data-toggle="collapse" data-target="#comment-{{comment.id}}-reply"><i class="icon-comment"></i>{% trans 'Reply to comment' %}</a>
            <div id="comment-{{comment.id}}-reply" class="collapse">
              <form action="{% locale_url courses_post_comment_reply course_id=course.id content_id=about.id comment_id=comment.id %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="next_url" value="{{course_url}}">
                <p><textarea id="id_comment" name="comment" cols="40" rows="2"></textarea></p>
                <input type="submit" value="{% trans "Post comment" %}"/>
              </form>
            </div>
          </div>
        {% endfor %}
  
        <div>
          <h3>{% trans 'Post new comment' %}</h3>
          <form action="{% locale_url courses_post_content_comment course_id=course.id content_id=about.id %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="next_url" value="{{course_url}}">
            <p><textarea id="id_comment" name="comment" cols="40" rows="2"></textarea></p>
            <input type="submit" value="{% trans "Post comment" %}"/>
          </form>
        </div>
        -->
      </div>
  
      <div class="tab-pane" id="badges-tab">
        {% if submission_enabled_badges %}
          <div class="bottom-sidebar">
            {% for badge in submission_enabled_badges %}
              {% if not forloop.first %}<hr class="badge-break">{% endif %}
              <div class="badge">
                {% with awards_count=badge.awards.count pending_count=badge.get_pending_submissions.count %}
                  <div class="badge-top">
                    <a href="{{ badge.get_absolute_url }}" title="{{ badge|title }}"><img class="badge-graphic" src="{{ badge.get_image_url }}" width="80" height="80" alt="{{ badge|title }}"/></a>
                    <div class="badge-awarded">
                      <a class="badge-awarded-header" href="{% locale_url awarded_matching_submissions slug=badge.slug %}">{{ _('Awarded') }}</a>
                      <a class="badge-awarded-number" href="{% locale_url awarded_matching_submissions slug=badge.slug %}">{{ awards_count }}</a>
                    </div>
                    <div class="badge-pending">
                      <a class="badge-pending-header" href="{% locale_url matching_submissions slug=badge.slug %}">{{ _('Pending') }}</a>
                      <a class="badge-pending-number" href="{% locale_url matching_submissions slug=badge.slug %}">{{ pending_count }}</a>
                    </div>
                  </div>
                  <div class="badge-bottom">
                    {% if pending_count %}
                      <a href="{% locale_url matching_submissions slug=badge.slug %}">
                        {% blocktrans count counter=pending_count %}{{ counter }} peer needs your review!{% plural %}{{ counter }} peers need your review!{% endblocktrans %} {{ _('Go') }} →
                      </a>
                    {% endif %}
                  </div>
                {% endwith %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
  
  
      </div>
 
      <div class="tab-pane" id="people-tab">
        <div id="learner-list" class="user-list">
          <h3>{% trans "Learners" %}</h3>
          <ul class="thumbnails">
            {% for user in cohort.learners %}
              {% include "courses/course_user_snip.html" %}
            {% endfor %}
          </ul>
        </div>
        <div id="learner-list" class="user-list">
          <h3>{% trans "Organizers" %}</h3>
          <ul class="unstyled">
          {% for user in cohort.organizers %}
            {% include "courses/course_user_snip.html" %}           
          {% endfor %}
          </ul>
        </div>
        <p>
            <form action="{% locale_url courses_add_user course_id=course.id %}" method="POST">
                {% csrf_token %}
                <input type="text" name="username" />
                <button type="submit">{% trans "Add user" %}</button>
            </form>
        </p>
      </div>

    </div>
  </div> <!-- /#tabbable -->
</div> <!-- /#main -->

</div> <!-- /#row -->

{% endblock %}

{% block js %}
  <script type="text/javascript">
    $(document).ready(function(){
      $("#id_start_date").datepicker();

    });
  </script>

  <script src="{{ STATIC_URL }}pagedown/Markdown.Converter.js"></script>
  <script src="{{ STATIC_URL }}pagedown/Markdown.Sanitizer.js"></script>
  <script src="{{ STATIC_URL }}pagedown/Markdown.Editor.js"></script>
  <script src="{{ STATIC_URL }}pagedown/Markdown.JQueryPlugin.js"></script>

  <script type="text/javascript">
    $(document).ready(function(){
      var converter1 = Markdown.getSanitizingConverter();
      var editor1 = new Markdown.Editor(converter1, "id_content");
      editor1.run();
    });
  </script>

{% endblock %}
